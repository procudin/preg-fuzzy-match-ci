define(["jquery","qtype_poasquestion/poasquestion_text_and_button"],function(a){var b={TREE_KEY:"tree",TREE_MAP_KEY:"map",GRAPH_KEY:"graph",DESCRIPTION_KEY:"description",SIMPLIFICATION_KEY:"simplification",STRINGS_KEY:"regex_test",TREE_MAP_ID:"#qtype_preg_tree",GRAPH_MAP_ID:"#qtype_preg_graph",www_root:null,textbutton_widget:null,regex_input:null,matching_options:["engine","notation","exactmatch","usecase","approximatematch","maxtypos"],prevdata:null,data:null,cache:{tree:{},graph:{},description:{},regex_test:{}},init:function(a,b){this.www_root=a,this.textbutton_widget=M.poasquestion_text_and_button,this.setup_parent_object()},simplification_hints:function(){return a("#simplification_tool_hints > tbody > tr > td")},tree_err:function(){return a("#tree_err")},tree_img:function(){return a("#tree_img")},graph_err:function(){return a("#graph_err")},graph_img:function(){return a("#graph_img")},desc_hnd:function(){return a("#description_handler")},setup_parent_object:function(){var c={onfirstpresscallback:function(){a.ajax({url:b.www_root+"/question/type/preg/authoring_tools/preg_authoring.php",type:"GET",dataType:"text"}).done(function(d,e,f){var g=M;a(b.textbutton_widget.dialog).html(a.parseHTML(d,document,!1)),M=a.extend(M,g),M.form&&M.form.shortforms&&M.form.shortforms({formid:"mformauthoring"}),a(b.textbutton_widget.dialog).find(".skiplinks").remove(),a("#id_regex_show").click(b.btn_show_clicked),b.textbutton_widget.is_stand_alone()?a("#id_regex_save").hide():a("#id_regex_save").click(b.btn_save_clicked),a("#id_regex_cancel").click(b.btn_cancel_clicked),a("#id_regex_check_strings").click(b.btn_check_strings_clicked),a("#id_graph_selection_mode").change(b.btn_graph_selection_mode_rectangle_selection_click),a("#simplification_tool_apply_btn").click(b.btn_apply_hint_click),a('input[name="authoring_tools_tree_orientation"]').change(b.rbtn_changed),a('input[name="authoring_tools_charset_process"]').change(b.rbtn_changed),b.regex_input=a("#id_regex_text"),b.regex_input.textareaHighlighter({matches:[]}),b.regex_input.bind("input propertychange",b.regex_text_changed),a(b.textbutton_widget.dialog).find("#region-main").css("margin-left",0),a("#id_regex_match_text").keyup(b.textbutton_widget.fix_textarea_rows),a("#id_regex_match_text").after('<div style="width:100%; display:inline-block">&nbsp;<div style="display:inline-block" id="id_test_regex" class="que"></div></div>'),a("#fgroup_id_charset_process_radioset").hide(),a(window).resize(b.resize_handler),b.resize_handler(),a(window).scroll(b.disable_panzooms),a(window).on("scrollstop",b.enable_panzooms),b.panzooms.init(),c.oneachpresscallback()})},oneachpresscallback:function(){b.regex_input.val(b.textbutton_widget.data).trigger("keyup"),b.invalidate_content(),b.data=b.regex_input.val(),b.textbutton_widget.is_stand_alone()||(a("#id_regex_match_text").val(a("input[name='regextests["+a(b.textbutton_widget.current_input).attr("id").split("id_answer_")[1]+"]']").val()).trigger("keyup"),a.each(b.matching_options,function(b,c){var d="#id_"+c,e=d+"_auth";a(e).val(a(d).val())})),a("#id_regex_show").click()},onclosecallback:function(){b.save_sections_state()},onsaveclicked:function(){a("#id_regex_save").click()},oncancelclicked:function(){a("#id_regex_cancel").click()}};b.textbutton_widget.setup(c)},disable_panzooms:function(){b.panzooms.disable_graph(),b.panzooms.disable_tree()},enable_panzooms:function(){b.panzooms.enable_graph(),b.panzooms.enable_tree()},is_changed:function(){return b.data!==b.prevdata},save_sections_state:function(){var b=["regex_input","regex_matching_options","regex_tree","regex_graph","regex_description","regex_testing"];a.each(b,function(b,c){var d=a("[name='mform_isexpanded_id_"+c+"_header']").val();M.util.set_user_preference("qtype_preg_"+c+"_expanded",d)})},btn_show_clicked:function(c){c.preventDefault(),b.data=b.regex_input.val(),b.is_changed()&&(a("input[name='tree_fold_node_points']").val(""),b.prevdata=b.data,b.panzooms.reset_all()),selection=a(b.regex_input).textrange("get"),indfirst=selection.start,indlast=selection.end-1,indfirst>indlast&&(indfirst=indlast=-2),a("input[name='tree_selected_node_points']").val(indfirst+","+indlast),b.load_content(indfirst,indlast,null,null),b.load_strings(indfirst,indlast)},btn_save_clicked:function(c){c.preventDefault(),b.textbutton_widget.data=b.regex_input.val(),a.each(b.matching_options,function(b,c){var d="#id_"+c,e=d+"_auth";a(d).val(a(e).val())}),b.textbutton_widget.close_and_set_new_data(b.textbutton_widget.data),a("input[name='regextests["+a(b.textbutton_widget.current_input).attr("id").split("id_answer_")[1]+"]']").val(a("#id_regex_match_text").val()),a("#id_test_regex").html(""),M.form.updateFormState("mform1")},btn_cancel_clicked:function(c){c.preventDefault(),b.textbutton_widget.dialog.dialog("close"),a("#id_test_regex").html("")},btn_check_strings_clicked:function(a){a.preventDefault();var c=b.get_selection();b.load_strings(c.indfirst,c.indlast)},btn_apply_hint_click:function(c){c.preventDefault();var d=b.get_hint();108==d.problem_type&&a("#id_exactmatch_auth").val("1"),b.load_apply_hints(d.problem_indfirst,d.problem_indlast,d.problem_ids,d.problem_type)},rbtn_changed:function(a){if(a.preventDefault(),"id_tree_folding_mode"!=a.currentTarget.id){var c=b.get_selection();b.load_content(c.indfirst,c.indlast,null,null),b.panzooms.reset_tree()}},regex_text_changed:function(c){c.preventDefault();var d=a("#simplification_tool_hints > tbody");d.empty(),a("#simplification_tool_hint_text").text(""),a("#simplification_tool_equivalences_count").text("0"),a("#simplification_tool_tips_count").text("0"),a("#simplification_tool_errors_count").text("0"),a("#simplification_tool_apply_btn").prop("disabled",!0),a("#simplification_tool_cancel_btn").prop("disabled",!0),b.regex_input.textareaHighlighter("updateMatches",[])},simplification_hints_clicked:function(c){c.preventDefault();for(var d=a("#simplification_tool_hints > tbody"),e=0;e<d.children().length;++e)"undefined"!=typeof d[0].children[e]&&(d[0].children[e].children[0].style.boxShadow="0 0 0 128px rgba(0, 0, 0, 0.0) inset");c.currentTarget.style.boxShadow="0 0 0 128px rgba(0, 0, 0, 0.1) inset",a("#simplification_tool_hint_text").text(c.currentTarget.children[1].value),a("#problem_ids")[0].value=c.currentTarget.children[2].value,a("#problem_type")[0].value=c.currentTarget.children[3].value,a("#problem_indfirst")[0].value=c.currentTarget.children[4].value,a("#problem_indlast")[0].value=c.currentTarget.children[5].value,"qtype_preg_regex_hint_nullable_regex"===c.currentTarget.children[3].value?a("#simplification_tool_apply_btn").prop("disabled",!0):a("#simplification_tool_apply_btn").prop("disabled",!1),a("#simplification_tool_cancel_btn").prop("disabled",!1),b.regex_input.textrange("set",0,0),b.regex_input.textareaHighlighter("updateMatches",[{type:"qtype-preg-orange",start:c.currentTarget.children[4].value,end:c.currentTarget.children[5].value}])},collapse_block_title_clicked:function(b){a("#simplification_tool_collapse_btn").hasClass("collapsed")?a("#collapse_block_toggle").css("background-image","url(/moodle/theme/image.php/clean/core/1461098461/t/expanded)"):a("#collapse_block_toggle").css("background-image","url(/moodle/theme/image.php/clean/core/1461098461/t/collapsed)")},tree_node_clicked:function(c){c.preventDefault();var d=a(a(c.target).parents(".node")[0]).attr("id").split(/_/),e=d[2],f=d[3];if(b.is_tree_foldind_mode()){var g=a("input[name='tree_fold_node_points']").val();if(g.indexOf(e+","+f)==-1?(""!=g&&(g+=";"),g+=e+","+f):g=g.indexOf(";"+e+","+f)!=-1?g.replace(";"+e+","+f,""):g.indexOf(e+","+f+";")!=-1?g.replace(e+","+f+";",""):g.replace(e+","+f,""),a("input[name='tree_fold_node_points']").val(g),"undefined"!=typeof a("input[name='tree_selected_node_points']").val()){var h=a("input[name='tree_selected_node_points']").val().split(",");e=h[0],f=h[1],b.load_content(e,f,null,null),b.load_strings(e,f)}else b.load_content(),b.load_strings()}else a("input[name='tree_selected_node_points']").val(e+","+f),b.load_content(e,f,null,null),b.load_strings(e,f)},check_keyword:function(a){var b=a.id.split(/_/);return"description"==b[0]},get_id_node:function(a){var b=a.id.split(/_/);return"description"==b[0]?b:b=a.parentNode.id.split(/_/)},get_high_node:function(a){for(var c=b.get_id_node(a),d=1;1!=c[2];)a=a.parentNode,c=b.get_id_node(a),d++;return d},get_LCA:function(a,c){if(b.get_high_node(a)>b.get_high_node(c))for(;b.get_high_node(a)>b.get_high_node(c);)a=a.parentNode;else for(;b.get_high_node(a)<b.get_high_node(c);)c=c.parentNode;for(;a.parentNode!=c.parentNode;)a=a.parentNode,c=c.parentNode;return{first:a,last:c}},description_node_clicked:function(a){if(a.preventDefault(),window.getSelection){var c=window.getSelection(),d=c.anchorNode.parentNode,e=c.focusNode.parentNode,f=c.anchorNode.nodeValue.toString().length,g=c.focusNode.nodeValue.toString().length,h=c.toString(),i=c.getRangeAt(0),j=h.length;b.check_keyword(d)&&" "==h[j-1]&&1==c.anchorOffset&&(i.setEndBefore(i.endContainer),c.removeAllRanges(),c.addRange(i),h=c.toString(),j=h.length,f=c.anchorNode.nodeValue.toString().length,g=c.focusNode.nodeValue.toString().length),b.check_keyword(e)&&" "==h[0]&&c.focusOffset==g-1&&(i.setStartAfter(i.startContainer),c.removeAllRanges(),c.addRange(i),h=c.toString(),j=h.length,f=c.anchorNode.nodeValue.toString().length),b.check_keyword(d)&&" "==h[0]&&c.anchorOffset==f-1&&(i.setStartAfter(i.startContainer),c.removeAllRanges(),c.addRange(i),h=c.toString(),j=h.length),b.check_keyword(e)&&" "==h[j-1]&&1==c.focusOffset&&(i.setEndBefore(i.endContainer),c.removeAllRanges(),c.addRange(i)),d=c.anchorNode.parentNode,e=c.focusNode.parentNode;var k,l,m=b.get_LCA(d,e);k=b.get_id_node(m.first),l=b.get_id_node(m.last);var n=k[3],o=l[4];b.load_content(n,o,null,null),b.load_strings(n,o)}},tree_node_misclicked:function(c){c.preventDefault(),b.is_tree_foldind_mode()||(a("input[name='tree_selected_node_points']").val(""),b.load_content(),b.load_strings())},graph_node_clicked:function(c){if(c.preventDefault(),!b.is_graph_selection_rectangle_visible()){var d=a(a(c.target).parents(".node")[0]).attr("id").split("_"),e=d[2],f=d[3];a("input[name='tree_selected_node_points']").val(e+","+f),b.load_content(e,f,null,null),b.load_strings(e,f)}},graph_node_misclicked:function(c){c.preventDefault(),b.is_graph_selection_rectangle_visible()||(a("input[name='tree_selected_node_points']").val(""),b.load_content(),b.load_strings())},is_tree_foldind_mode:function(){return a("#id_tree_folding_mode").is(":checked")},is_graph_selection_rectangle_visible:function(){return a("#id_graph_selection_mode").is(":checked")},cache_key_for_explaining_tools:function(a,b){return""},cache_key_for_testing_tool:function(c,d){return""+b.regex_input.val()+a("#id_engine_auth").val()+a("#id_notation_auth").val()+a("#id_exactmatch_auth").val()+a("#id_approximatematch_auth").val()+a("#id_maxtypos_auth").val()+a("#id_usecase_auth").val()+a("#id_regex_match_text").val()+c+","+d},upd_content_success:function(a,c,d){var e="object"==typeof a?a:JSON.parse(a),f=e.regex,g=e.notation,h=e.exactmatch,i=e.approximatematch,j=e.maxtypos,k=e.usecase,l=e.treeorientation,m=e.displayas,n=parseInt(e.indfirst),o=parseInt(e.indlast),p=parseInt(e.indfirstorig),q=parseInt(e.indlastorig),r=e[b.TREE_KEY],s=e[b.GRAPH_KEY],t=e[b.DESCRIPTION_KEY],u=e[b.SIMPLIFICATION_KEY],v=""+f+g+h+i+j+k+l+m+n+","+o;b.cache[b.TREE_KEY][v]=r,b.cache[b.GRAPH_KEY][v]=s,b.cache[b.DESCRIPTION_KEY][v]=t,b.regex_input.val(f),b.display_content(r,s,t,u,n,o,p,q)},upd_strings_success:function(a,c,d){var e="object"==typeof a?a:JSON.parse(a),f=e.regex,g=e.engine,h=e.notation,i=e.exactmatch,j=e.approximatematch,k=e.maxtypos,l=e.usecase,m=(e.treeorientation,e.displayas,e.indfirst),n=e.indlast,o=e.strings,p=e[b.STRINGS_KEY],q=""+f+g+h+i+j+k+l+o+m+","+n;b.cache[b.STRINGS_KEY][q]=p,b.display_strings(p)},invalidate_content:function(){b.tree_err().html(""),b.tree_img().css("visibility","hidden"),b.graph_err().html(""),b.graph_img().css("visibility","hidden"),b.desc_hnd().html("")},display_content:function(c,d,e,f,g,h,i,j){a(window).scrollTop();if(b.invalidate_content(),"undefined"!=typeof c&&c.img){b.tree_img().css("visibility","visible").html(c.img),b.tree_img().click(b.tree_node_misclicked),a("svg .node",b.tree_img()).click(b.tree_node_clicked);var k=a("#tree_img svg").attr("height"),l=a("#tree_img svg").attr("width");a("#tree_img svg").attr("height",k.replace("pt","px")),a("#tree_img svg").attr("width",l.replace("pt","px")),a("#tree_img")[0].title="";for(var m=a("#tree_img svg")[0].children[0].children,n=0;n<m.length;++n)m[n].id.indexOf("edge")>-1?m[n].children[0].innerHTML="":0==n?m[n].innerHTML="":m[n].id.indexOf("graph2")>-1&&(m[n].children[0].innerHTML="")}else"undefined"!=typeof c&&b.tree_err().html(c);if("undefined"!=typeof d&&d.img){b.graph_img().css("visibility","visible").html(d.img),b.graph_img().click(b.graph_node_misclicked),a("svg .node",b.graph_img()).click(b.graph_node_clicked);var k=a("#graph_img svg").attr("height"),l=a("#graph_img svg").attr("width");a("#graph_img svg").attr("height",k.replace("pt","px")),a("#graph_img svg").attr("width",l.replace("pt","px")),a("#graph_img").mousedown(function(a){a.preventDefault(),b.is_graph_selection_rectangle_visible()&&b.init_rectangle_selection(a,"graph_img","resizeGraph","graph_hnd")}),a("#graph_img").mousemove(function(a){a.preventDefault(),b.resize_rectangle_selection(a,"graph_img","resizeGraph","graph_hnd")}),a(window).mouseup(function(c){if(c.preventDefault(),1==b.CALC_COORD){b.CALC_COORD=!1;var d=a("#explaining_graph").attr("transform"),e=/.*translate\(\s*(\d+)\s+(\d+).*/g.exec(d),f=e[1],g=e[2],h=b.get_rect_selection(c,"resizeGraph","graph_img",document.getElementById("graph_hnd").getBoundingClientRect().left-document.getElementById("graph_img").getBoundingClientRect().left+parseInt(f)-a("#graph_hnd").prop("scrollLeft"),document.getElementById("graph_hnd").getBoundingClientRect().top-document.getElementById("graph_img").getBoundingClientRect().top+parseInt(g)+a("#graph_hnd").prop("scrollTop"));a("input[name='tree_selected_node_points']").val(h.indfirst+","+h.indlast),b.load_content(h.indfirst,h.indlast,null,null),b.load_strings(h.indfirst,h.indlast),a("#resizeGraph").css({width:0,height:0,left:-10,top:-10})}})}else"undefined"!=typeof d&&b.graph_err().html(d);if("undefined"!=typeof f){var o=function(a,c,d,e,f,g){return b.get_hint_row(a,c,d,e,f,g,"error","color: #222222;")},p=function(a,c,d,e,f,g){return b.get_hint_row(a,c,d,e,f,g,"warning","font-weight: normal;")},q=function(a,c,d,e,f,g){return b.get_hint_row(a,c,d,e,f,g,"info","")};a("#simplification_tool_errors_count").text(f.errors.length),a("#simplification_tool_tips_count").text(f.tips.length),a("#simplification_tool_equivalences_count").text(f.equivalences.length),f.errors.length>0||f.tips.length>0||f.equivalences.length>0?a("#simplification_tool_collapse_btn").css("pointer-events","auto"):a("#simplification_tool_collapse_btn").css("pointer-events","none"),a("#simplification_tool_collapse_btn").click(b.collapse_block_title_clicked);var r=a("#simplification_tool_hints > tbody");r.empty(),a("#simplification_tool_hint_text").empty();for(var n=0;n<f.errors.length;++n)r.append(o(f.errors[n].problem,f.errors[n].solve,f.errors[n].problem_ids,f.errors[n].problem_type,f.errors[n].problem_indfirst,f.errors[n].problem_indlast));for(var n=0;n<f.tips.length;++n)r.append(p(f.tips[n].problem,f.tips[n].solve,f.tips[n].problem_ids,f.tips[n].problem_type,f.tips[n].problem_indfirst,f.tips[n].problem_indlast));for(var n=0;n<f.equivalences.length;++n)r.append(q(f.equivalences[n].problem,f.equivalences[n].solve,f.equivalences[n].problem_ids,f.equivalences[n].problem_type,f.equivalences[n].problem_indfirst,f.equivalences[n].problem_indlast));b.simplification_hints().click(b.simplification_hints_clicked),a("#simplification_tool_apply_btn").prop("disabled",!0),a("#simplification_tool_cancel_btn").prop("disabled",!0)}"undefined"!=typeof e&&(b.desc_hnd().html(e),b.desc_hnd().mouseup(b.description_node_clicked));var s=h-g+1;g<0&&(g=0),h<0&&(s=0),b.regex_input.textrange("set",0,0),b.regex_input.textareaHighlighter("updateMatches",[{type:"qtype-preg-orange",start:g,end:h}])},get_hint_row:function(a,b,c,d,e,f,g,h){return'<tr class="'+g+'"  style="'+h+'"><td><span>'+a+'</span><input type="hidden" value="'+b+'"><input type="hidden" value="'+c+'"><input type="hidden" value="'+d+'"><input type="hidden" value="'+e+'"><input type="hidden" value="'+f+'"><button type="button" class="close" data-dismiss="alert"><i class="icon-remove"></i></button></td></tr>'},resize_rectangle_selection:function(c,d,e,f){if(b.CALC_COORD){var g=(document.getElementById(d).getBoundingClientRect(),b.get_current_x(c,d,f)),h=b.get_current_y(c,d,f);b.RECTANGLE_WIDTH<g&&b.RECTANGLE_HEIGHT<h?a("#"+e).css({width:g-b.RECTANGLE_WIDTH-10,height:h-b.RECTANGLE_HEIGHT-10}):b.RECTANGLE_WIDTH<g&&b.RECTANGLE_HEIGHT>h?a("#"+e).css({width:g-b.RECTANGLE_WIDTH-10,height:b.RECTANGLE_HEIGHT-h-10,top:h}):b.RECTANGLE_WIDTH>g&&b.RECTANGLE_HEIGHT>h?a("#"+e).css({width:b.RECTANGLE_WIDTH-g-10,height:b.RECTANGLE_HEIGHT-h-10,top:h,left:g}):b.RECTANGLE_WIDTH>g&&b.RECTANGLE_HEIGHT<h&&a("#"+e).css({width:b.RECTANGLE_WIDTH-g-10,height:h-b.RECTANGLE_HEIGHT-10,left:g});for(var i=a("#explaining_graph").attr("transform"),j=/.*translate\(\s*(\d+)\s+(\d+).*/g.exec(i),k=j[1],l=j[2],m=document.getElementById("graph_hnd").getBoundingClientRect().left-document.getElementById("graph_img").getBoundingClientRect().left+parseInt(k)-a("#graph_hnd").prop("scrollLeft"),n=document.getElementById("graph_hnd").getBoundingClientRect().top-document.getElementById("graph_img").getBoundingClientRect().top+parseInt(l)+a("#graph_hnd").prop("scrollTop"),o=b.get_figures_in_rect("resizeGraph","graph_img",m,n),p=a("ellipse, polygon","#"+d+" > svg > g"),q=0;q<p.length;++q)a(p[q]).attr("opacity","1.0");for(var q=0;q<o.length;++q)a(o[q]).attr("opacity","0.5")}},init_rectangle_selection:function(c,d,e,f){b.CALC_COORD=!0,a("#"+e).Resizable({minWidth:20,minHeight:20,maxWidth:9999,maxHeight:9999,minTop:1,minLeft:1,maxRight:9999,maxBottom:9999,dragHandle:!0,onDrag:function(a,b){this.style.backgroundPosition="-"+(a-50)+"px -"+(b-50)+"px"},onResize:function(a,b){this.style.backgroundPosition="-"+(b.left-50)+"px -"+(b.top-50)+"px"}}),b.RECTANGLE_WIDTH=b.get_current_x(c,d,f),b.RECTANGLE_HEIGHT=b.get_current_y(c,d,f),a("#"+e).css({width:20,height:20,left:b.RECTANGLE_WIDTH,top:b.RECTANGLE_HEIGHT,visibility:"visible"})},get_current_x:function(b,c,d){var e=void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft;return b.pageX-e-document.getElementById(c).getBoundingClientRect().left-(document.getElementById(d).getBoundingClientRect().left-document.getElementById(c).getBoundingClientRect().left)+a("#"+d).prop("scrollLeft")},get_current_y:function(b,c,d){var e=void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;return b.pageY-e-document.getElementById(c).getBoundingClientRect().top-(document.getElementById(d).getBoundingClientRect().top-document.getElementById(c).getBoundingClientRect().top)+a("#"+d).prop("scrollTop")},detect_rect:function(a){var b=a.coords.split(/[, ]/).map(function(a){return parseInt(a)});if(8==b.length){for(var c=[],d=0;d<b.length;d+=2)c[c.length]={x:b[d],y:b[d+1]};var e={x:Math.floor(c[0].x+(c[2].x-c[0].x)/2),y:Math.floor(c[0].y+(c[2].y-c[0].y)/2)};return a.coords+=","+e.x+","+e.y,!0}return!1},get_figures_in_rect:function(b,c,d,e){rect_left_bot_x=a("#"+b).prop("offsetLeft")+d,rect_left_bot_y=a("#"+b).prop("offsetTop")+a("#"+b).prop("offsetHeight")-e,rect_right_top_x=a("#"+b).prop("offsetLeft")+a("#"+b).prop("offsetWidth")+d,rect_right_top_y=a("#"+b).prop("offsetTop")-e;for(var f=a(".edge, .node, .cluster","#"+c+" > svg > g"),g=[],h=0;h<f.length;++h){var i=f[h].id.split("_");if(4==i.length){var j=null;switch(f[h].getAttribute("class")){case"node":j=a("ellipse, polygon",f[h])[0],0==j.length&&(j=a("polygon","#"+f[h].id+" > g > a")[0]);break;case"edge":j=a("path",f[h])[0];var k=a("polygon",f[h])[0];break;case"cluster":j=a("polygon","#"+f[h].id+" > g > a")[0],void 0===j&&(j=a("polygon","#"+f[h].id+" > a")[0]);break;default:continue}if(a(j).is("ellipse"))var l=[{x:j.cx.baseVal.value,y:j.cy.baseVal.value}];else if(a(j).is("polygon"))for(var l=[],m=0;m<j.points.numberOfItems;++m)l.push({x:j.points.getItem(m).x,y:j.points.getItem(m).y});else{if(!a(j).is("path"))continue;for(var l=[],n=j.getAttribute("d"),o=n.indexOf("C"),p=n.substring(1,o).split(","),q={x:parseFloat(p[0]),y:parseFloat(p[1])},r=n.substring(o+1).split(" "),m=0;m<r.length;++m){var s=r[m].split(",");l.push({x:parseFloat(s[0]),y:parseFloat(s[1])})}l=l.filter(function(a){var b=k.points.getItem(1).x,c=b-q.x;return a.x<b-.15*c&&a.x>q.x+.15*c})}for(var m=0;m<l.length;++m)rect_left_bot_x<l[m].x&&rect_right_top_x>l[m].x&&rect_left_bot_y+2*(document.getElementById("graph_hnd").getBoundingClientRect().top-document.getElementById("graph_img").getBoundingClientRect().top)>l[m].y&&rect_right_top_y+2*(document.getElementById("graph_hnd").getBoundingClientRect().top-document.getElementById("graph_img").getBoundingClientRect().top)<l[m].y&&g.push(j)}}return g},get_rect_selection:function(b,c,d,e,f){rect_left_bot_x=a("#"+c).prop("offsetLeft")+e,rect_left_bot_y=a("#"+c).prop("offsetTop")+a("#"+c).prop("offsetHeight")-f,rect_right_top_x=a("#"+c).prop("offsetLeft")+a("#"+c).prop("offsetWidth")+e,rect_right_top_y=a("#"+c).prop("offsetTop")-f;for(var g=a(".edge, .node, .cluster","#"+d+" > svg > g"),h=999,i=-999,j=0;j<g.length;++j){var k=g[j].id.split("_");if(4==k.length){var l=null;switch(g[j].getAttribute("class")){case"node":l=a("ellipse, polygon",g[j])[0],0==l.length&&(l=a("polygon","#"+g[j].id+" > g > a")[0]);break;case"edge":l=a("path",g[j])[0];var m=a("polygon",g[j])[0];break;case"cluster":l=a("polygon","#"+g[j].id+" > g > a")[0],void 0===l&&(l=a("polygon","#"+g[j].id+" > a")[0]);break;default:continue}if(a(l).is("ellipse"))var n=[{x:l.cx.baseVal.value,y:l.cy.baseVal.value}];else if(a(l).is("polygon"))for(var n=[],o=0;o<l.points.numberOfItems;++o)n.push({x:l.points.getItem(o).x,y:l.points.getItem(o).y});else{if(!a(l).is("path"))continue;for(var n=[],p=l.getAttribute("d"),q=p.indexOf("C"),r=p.substring(1,q).split(","),s={x:parseFloat(r[0]),y:parseFloat(r[1])},t=p.substring(q+1).split(" "),o=0;o<t.length;++o){var u=t[o].split(",");n.push({x:parseFloat(u[0]),y:parseFloat(u[1])})}n=n.filter(function(a){var b=m.points.getItem(1).x,c=b-s.x;return a.x<b-.15*c&&a.x>s.x+.15*c})}for(var o=0;o<n.length;++o)rect_left_bot_x<n[o].x&&rect_right_top_x>n[o].x&&rect_left_bot_y+2*(document.getElementById("graph_hnd").getBoundingClientRect().top-document.getElementById("graph_img").getBoundingClientRect().top)>n[o].y&&rect_right_top_y+2*(document.getElementById("graph_hnd").getBoundingClientRect().top-document.getElementById("graph_img").getBoundingClientRect().top)<n[o].y&&(parseInt(k[2])<parseInt(h)&&(h=k[2]),parseInt(k[3])>parseInt(i)&&(i=k[3]))}}return 999!=parseInt(h)&&parseInt(i)!=-999||(h=i=-2),{indfirst:h,indlast:i}},display_strings:function(b){a("#id_test_regex").html(b)},btn_graph_selection_mode_rectangle_selection_click:function(c){c.preventDefault(),b.is_graph_selection_rectangle_visible()?b.panzooms.disable_graph():(b.panzooms.enable_graph(),a("#resizeGraph").css({width:0,height:0,left:-10,top:-10}))},load_content:function(c,d,e,f){"undefined"!=typeof c&&"undefined"!=typeof d||(c=d=-2),"undefined"!=typeof e&&"undefined"!=typeof f&&null!=e&&null!=typeof f||(e="",f=-2),b.tree_img().unbind("click",b.tree_node_misclicked),a("svg .node",b.tree_img()).unbind("click",b.tree_node_clicked),b.graph_img().unbind("click",b.graph_node_misclicked),a("svg .node",b.graph_img()).unbind("click",b.graph_node_clicked),b.desc_hnd().unbind("mouseup",b.description_node_clicked);var g=b.cache_key_for_explaining_tools(c,d),h=b.cache[b.TREE_KEY][g];return h?void b.display_content(b.cache[b.TREE_KEY][g],b.cache[b.GRAPH_KEY][g],b.cache[b.DESCRIPTION_KEY][g],c,d):void a.ajax({type:"GET",url:b.www_root+"/question/type/preg/authoring_tools/preg_authoring_tools_loader.php",data:{regex:b.regex_input.val(),engine:a("#id_engine_auth :selected").val(),notation:a("#id_notation_auth :selected").val(),exactmatch:a("#id_exactmatch_auth :selected").val(),approximatematch:a("#id_approximatematch_auth :selected").val(),maxtypos:a("#id_maxtypos_auth").val(),usecase:a("#id_usecase_auth :selected").val(),indfirst:c,indlast:d,treeorientation:b.get_orientation(),displayas:b.get_displayas(),foldcoords:a("input[name='tree_fold_node_points']").val(),treeisfold:a("#id_tree_folding_mode").is(":checked")?1:0,problem_ids:e,problem_type:f,ajax:!0},success:b.upd_content_success})},load_strings:function(c,d){"undefined"!=typeof c&&"undefined"!=typeof d||(c=d=-2);var e=b.cache_key_for_testing_tool(c,d),f=b.cache[b.STRINGS_KEY][e];return f?void b.display_strings(f):void a.ajax({type:"GET",url:b.www_root+"/question/type/preg/authoring_tools/preg_regex_testing_tool_loader.php",data:{regex:b.regex_input.val(),engine:a("#id_engine_auth :selected").val(),notation:a("#id_notation_auth :selected").val(),exactmatch:a("#id_exactmatch_auth :selected").val(),approximatematch:a("#id_approximatematch_auth :selected").val(),maxtypos:a("#id_maxtypos_auth").val(),usecase:a("#id_usecase_auth :selected").val(),indfirst:c,indlast:d,strings:a("#id_regex_match_text").val(),ajax:!0},success:b.upd_strings_success})},get_selection:function(){var b=a(window).scrollTop(),c=indlast=-2;if("undefined"!=typeof a("input[name='tree_selected_node_points']").val()){var d=a("input[name='tree_selected_node_points']").val().split(",");c=d[0],indlast=d[1]}return c>indlast&&(c=indlast=-2),a(window).scrollTop(b),{indfirst:c,indlast:indlast}},get_orientation:function(){return a('input[name="authoring_tools_tree_orientation"]:checked').val()},get_displayas:function(){return a('input[name="authoring_tools_charset_process"]:checked').val()},get_hint:function(){return{problem_ids:a("#problem_ids").val(),problem_type:a("#problem_type").val(),problem_indfirst:parseInt(a("#problem_indfirst").val()),problem_indlast:parseInt(a("#problem_indlast").val())}},load_apply_hints:function(a,c,d,e){b.load_content(a,c,d,e),b.load_strings()},resize_handler:function(){a("#tree_hnd").css("width",a("#mformauthoring").prop("offsetWidth")-37),a("#graph_hnd").css("width",a("#mformauthoring").prop("offsetWidth")-37)},panzooms:{reset_tree:function(){b.tree_img().panzoom("reset")},reset_graph:function(){b.graph_img().panzoom("reset")},disable_tree:function(){b.tree_img().panzoom("disable")},disable_graph:function(){b.graph_img().panzoom("instance")._unbind(),b.graph_img().off("mousewheel.focal",this._zoom)},enable_tree:function(){b.tree_img().panzoom("enable")},enable_graph:function(){b.graph_img().panzoom("instance")._bind(),b.graph_img().on("mousewheel.focal",this._zoom)},reset_all:function(){b.panzooms.reset_tree(),b.panzooms.reset_graph(),b.panzooms.reset_tree_dimensions(),b.panzooms.reset_graph_dimensions()},reset_tree_dimensions:function(){b.tree_img().panzoom("resetDimensions")},reset_graph_dimensions:function(){b.graph_img().panzoom("resetDimensions")},init_tree:function(){b.tree_img().panzoom();b.tree_img().on("mousewheel.focal",this._zoom),b.tree_img().panzoom("option","pan",!1)},init_graph:function(){b.graph_img().panzoom();b.graph_img().on("mousewheel.focal",this._zoom)},init:function(){b.panzooms.init_graph(),b.panzooms.init_tree()},_zoom:function(b){b.preventDefault();var c=b.delta||b.originalEvent.wheelDelta,d=c?c<0:b.originalEvent.deltaY>0,e=a(b.target).parents(".preg_img_panzoom")[0];a(e).panzoom("zoom",d,{increment:.1,focal:b})}},CALC_COORD:!1,RECTANGLE_WIDTH:0,RECTANGLE_HEIGHT:0};return M.preg_authoring_tools_script=b});